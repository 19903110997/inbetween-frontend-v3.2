<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>In-between | 意识共振协议终端 v3.3 融合版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@200;500;900&family=JetBrains+Mono:wght@100;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- V3.3 融合版样式：V3.2 完整功能 + 总监版优化 --- */
        :root {
            --bg-deep: #030508;
            --sattva-cyan: #22d3ee;
            --rajas-amber: #f59e0b;
            --tamas-slate: #1e293b;
            --lake-blue: rgba(10, 31, 51, 0.75);
            --transition-slow: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background-color: var(--bg-deep);
            color: #e2e8f0;
            font-family: 'JetBrains Mono', 'Noto Serif SC', serif;
            overflow: hidden;
            height: 100vh;
            height: 100dvh;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .view { 
            display: none; opacity: 0; transform: scale(0.99); transition: var(--transition-slow);
            width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center;
        }
        .view.active { display: flex; opacity: 1; transform: scale(1); }

        /* 湖蓝色面板 - 融合版优化 */
        .terminal-panel {
            background: var(--lake-blue); 
            backdrop-filter: blur(40px);
            border: 1px solid rgba(34, 211, 238, 0.12);
            position: relative;
            width: 88%; max-width: 480px;
            padding: 20px 15px;
            border-radius: 2rem; 
            box-shadow: 0 40px 80px -20px rgba(0,0,0,0.8);
            transition: all 0.5s ease;
        }
        @media (min-width: 768px) { .terminal-panel { padding: 35px 40px; } }

        /* 【总监版】对话面板 - 手机端友好布局 */
        .chat-panel {
            max-width: 680px; 
            height: 65vh;
            display: flex; 
            flex-direction: column; 
            padding: 0 !important;
        }
        @media (min-width: 768px) { .chat-panel { height: 580px; } }

        /* 动态背景 */
        #resonance-canvas {
            position: fixed; inset: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none; opacity: 0.6;
            mask-image: radial-gradient(circle at center, black 30%, transparent 90%);
        }

        /* 滴定水滴 */
        .titration-anchor {
            position: absolute; top: 15px; right: 15px; width: 16px; height: 120px; pointer-events: none; overflow: hidden; z-index: 10;
        }
        .titration-fluid {
            width: 8px;
            height: 8px;
            background: var(--sattva-cyan);
            border-radius: 50%;
            filter: blur(2px);
            margin: 0 auto;
            animation: drip 6s infinite;
        }
        @keyframes drip {
            0%, 30% { transform: translateY(-60px); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(100px); opacity: 0; }
        }

        /* 【总监版新增】昵称输入框 */
        .glow-input {
            background: transparent; border: none;
            border-bottom: 0.5px solid rgba(34, 211, 238, 0.2);
            padding: 4px 0px; color: #fff; font-family: 'JetBrains Mono';
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100px; text-align: center; font-size: 0.85rem;
        }
        .glow-input::placeholder { color: rgba(226, 232, 240, 0.12); font-weight: 200; }
        .glow-input:focus { outline: none; border-bottom-color: rgba(34, 211, 238, 0.6); width: 120px; }

        /* 【总监版新增】AI 呼吸头像 */
        .ai-avatar {
            width: 28px; height: 28px;
            background: radial-gradient(circle, var(--sattva-cyan) 0%, transparent 75%);
            border-radius: 50%; filter: blur(3px);
            animation: aura-breathe 4s infinite ease-in-out;
            position: relative;
        }
        .ai-avatar.active { animation: aura-breathe-fast 1.5s infinite ease-in-out; filter: blur(5px); }
        @keyframes aura-breathe { 0%, 100% { transform: scale(1); opacity: 0.4; } 50% { transform: scale(1.3); opacity: 0.6; } }
        @keyframes aura-breathe-fast { 0%, 100% { transform: scale(1.1); opacity: 0.5; } 50% { transform: scale(1.4); opacity: 0.8; } }

        .typing-cursor::after { content: '_'; animation: blink 1s infinite; color: var(--sattva-cyan); }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* 模式选择 */
        .crystal-selector {
            transition: all 0.3s ease; cursor: pointer; display: inline-flex; align-items: center; gap: 0.8rem; padding: 8px 10px;
        }
        @media (min-width: 768px) { .crystal-selector { gap: 1.5rem; padding: 10px 20px; } }
        
        .mode-text {
            color: #e2e8f0; font-weight: 300; font-size: 1.1rem; letter-spacing: 0.1em; transition: var(--transition-slow); white-space: nowrap;
        }
        @media (min-width: 768px) { .mode-text { font-size: 1.25rem; } }
        
        .crystal-selector:hover .mode-text { color: var(--sattva-cyan); text-shadow: 0 0 10px rgba(34, 211, 238, 0.3); }
        .rajas-arrow {
            color: var(--rajas-amber); font-family: 'JetBrains Mono'; font-weight: 700; font-size: 1.25rem; animation: pulse-arrow 1.5s infinite;
        }
        @keyframes pulse-arrow { 0%, 100% { transform: translateX(0); opacity: 0.7; } 50% { transform: translateX(5px); opacity: 1; } }

        .glow-btn {
            @apply px-10 md:px-14 py-3 border border-cyan-500/20 text-cyan-400 text-[10px] md:text-[11px] tracking-[0.4em] md:tracking-[0.6em] uppercase transition-all rounded-full;
            background: rgba(34, 211, 238, 0.01); color: var(--sattva-cyan);
        }
        .glow-btn:hover {
            background: rgba(34, 211, 238, 0.05); border-color: rgba(34, 211, 238, 0.4); box-shadow: 0 0 20px rgba(34, 211, 238, 0.15); color: #fff;
        }
        .footer-info { @apply py-3 px-6 md:px-8 rounded-full border border-white/5 bg-black/20 group transition-all hover:border-cyan-500/30 cursor-pointer hover:bg-cyan-900/10 max-w-[90%]; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <!-- 动态背景 Canvas -->
    <canvas id="resonance-canvas"></canvas>

    <!-- 顶部导航条 -->
    <nav class="fixed top-0 left-0 right-0 z-20 flex items-center justify-between px-4 md:px-8 py-3 md:py-4 bg-black/30 backdrop-blur-md border-b border-white/5">
        <div class="flex items-center gap-3 md:gap-4">
            <div class="w-2 h-2 rounded-full bg-cyan-400 animate-pulse"></div>
            <span class="text-[10px] md:text-xs text-slate-400 tracking-widest uppercase">USER</span>
            <span id="user-id-display" class="text-[10px] md:text-xs text-cyan-400 font-mono tracking-wider"></span>
        </div>
        <div id="stage-text" class="text-[8px] md:text-[9px] text-slate-600 uppercase tracking-[0.3em]">OBSERVING...</div>
    </nav>

    <!-- 底部微进度条 -->
    <div class="fixed bottom-0 left-0 right-0 h-0.5 bg-slate-900/50 z-20">
        <div id="subtle-progress" class="h-full bg-cyan-400/30 transition-all duration-1000" style="width: 40%"></div>
    </div>

    <!-- 1. 首页 -->
    <section id="view-landing" class="view active space-y-6 md:space-y-8 z-10 px-4">
        <header class="text-center space-y-2">
            <h1 class="text-4xl md:text-5xl font-extralight tracking-[0.2em] italic text-slate-100" style="font-family: 'Noto Serif SC'">
                In-between <span class="text-cyan-400">间隙</span>
            </h1>
            <p class="text-slate-600 text-[8px] md:text-[9px] tracking-[0.6em] uppercase">协议终端 v3.3 融合版</p>
        </header>

        <div class="terminal-panel flex flex-col items-center">
            <div class="titration-anchor"><div class="titration-fluid"></div></div>

            <div class="w-full flex flex-col items-center space-y-6 md:space-y-8">
                <!-- 【总监版新增】昵称输入 -->
                <div class="space-y-3 text-center">
                    <label class="text-[9px] text-slate-500 tracking-[0.3em] uppercase block">你想让 In 怎么称呼你？</label>
                    <input type="text" id="nickname-input" placeholder="输入昵称..." class="glow-input" autocomplete="off">
                </div>

                <!-- 模式选择 -->
                <div class="space-y-3 text-center w-full">
                    <label class="text-[8px] text-slate-600 tracking-[0.3em] uppercase block">选择当前结晶点</label>
                    <div onclick="cycleMode()" class="crystal-selector group">
                        <span id="mode-text" class="mode-text group-hover:text-cyan-400">亲密关系冲突</span>
                        <span class="rajas-arrow">></span>
                    </div>
                </div>

                <!-- START 按钮 -->
                <div class="pt-4 w-full flex justify-center">
                    <button onclick="startSession()" class="glow-btn" id="start-btn">START</button>
                </div>
            </div>
        </div>

        <div class="footer-info">
            <div onclick="switchView('view-intro')" class="text-[9px] text-slate-600 tracking-widest uppercase text-center">
                ABOUT PROTOCOL
            </div>
        </div>
    </section>

    <!-- 2. 对话区 - 使用总监版的手机端友好布局 -->
    <section id="view-chat" class="view space-y-4 px-4 md:px-6 z-10">
        <!-- Guna 仪表盘 -->
        <div class="w-full max-w-[560px] flex gap-4 opacity-50" id="guna-panel">
            <div class="flex-1 space-y-1">
                <div class="flex justify-between text-[7px] text-amber-500 uppercase tracking-tighter"><span>RAJAS</span><span id="rajas-val">30%</span></div>
                <div class="h-[1px] bg-slate-800 w-full"><div id="rajas-bar" class="h-full bg-amber-500/50 transition-all duration-1000" style="width: 30%"></div></div>
            </div>
            <div class="flex-1 space-y-1">
                <div class="flex justify-between text-[7px] text-cyan-400 uppercase tracking-tighter"><span>SATTVA</span><span id="sattva-val">40%</span></div>
                <div class="h-[1px] bg-slate-800 w-full"><div id="sattva-bar" class="h-full bg-cyan-400/50 transition-all duration-1000" style="width: 40%"></div></div>
            </div>
        </div>

        <!-- 对话头部 -->
        <div class="w-full max-w-[680px] flex justify-between items-end px-2">
            <div class="space-y-1">
                <h2 class="text-[10px] font-light tracking-widest text-slate-500 italic uppercase" id="chat-mode-title">INTIMACY_RESONANCE</h2>
                <div class="text-[8px] text-cyan-500/50 uppercase tracking-widest" id="chat-phase-indicator">PHASE: SCANNING</div>
            </div>
            <button onclick="exitProtocol()" class="text-[8px] text-slate-600 uppercase tracking-widest border border-slate-900 px-3 py-1 rounded-full hover:text-slate-300">EXIT</button>
        </div>

        <!-- 【总监版】对话面板 - 沉底布局 -->
        <div class="terminal-panel chat-panel border border-cyan-500/10">
            <!-- 消息流：flex-1 占据所有剩余空间 -->
            <div id="chat-flow" class="flex-1 p-6 md:p-10 space-y-10 overflow-y-auto no-scrollbar scroll-smooth w-full"></div>
            
            <!-- 输入区：锁定在底部 -->
            <div class="p-6 md:p-8 border-t border-white/5 bg-black/40 w-full">
                <div id="typing-indicator" class="text-[8px] text-cyan-500/40 mb-2 tracking-widest uppercase hidden">Titrating...</div>
                <div class="flex gap-4 items-end">
                    <textarea id="user-input" placeholder="注入场域体征..." class="flex-1 bg-transparent border-none focus:ring-0 text-sm text-slate-200 resize-none h-12 py-2 placeholder-slate-700 font-light disabled:opacity-20" disabled></textarea>
                    <button id="send-btn" onclick="sendMessage()" class="w-10 h-10 bg-cyan-500/5 hover:bg-cyan-500/15 text-cyan-400 rounded-full flex items-center justify-center transition-all shrink-0 disabled:opacity-20" disabled>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- 【V3.2保留】报告触发按钮 -->
        <div id="report-trigger" class="w-full max-w-[680px] text-center" style="opacity: 0; pointer-events: none; transition: opacity 0.5s;">
            <button onclick="generateReport()" class="text-[8px] text-cyan-600 hover:text-cyan-400 tracking-widest uppercase transition-colors">GENERATE REPORT</button>
        </div>
    </section>

    <!-- 3. 简介 -->
    <section id="view-intro" class="view px-8">
        <div class="terminal-panel space-y-6 text-sm font-light text-slate-400 leading-relaxed">
            <h2 class="text-xl text-slate-100 italic">Resonance Protocol</h2>
            <p>我们不解决问题。我们通过引入"基准波"来观察结晶。当干涉发生时，旧的模式会因为失去支点而坍塌。</p>
            <button onclick="switchView('view-landing')" class="text-[9px] text-cyan-500 uppercase tracking-widest pt-4 underline">Back to Terminal</button>
        </div>
    </section>

    <!-- 4. 【V3.2保留 + 修改】代谢锁视图 - 添加报告按钮 -->
    <section id="view-metabolism" class="view px-4">
        <div class="terminal-panel space-y-8 text-center max-w-md">

            <!-- 【新增】报告生成按钮 -->
            <button onclick="generateReport()" class="glow-btn mb-6">
                生成观察报告
            </button>

            <div class="titration-anchor"><div class="titration-fluid"></div></div>
            <h2 class="text-2xl md:text-3xl italic text-cyan-400 font-light tracking-wide">代谢期已启动</h2>
            <div id="metabolic-timer" class="text-4xl md:text-5xl font-mono text-amber-400 tracking-wider"></div>
            <p class="text-sm text-slate-400 leading-relaxed px-4">
                给自己一些时间，让洞见沉淀。<br>
                <span class="text-xs text-slate-600 italic mt-2 block">你已经看见了，现在需要的是呼吸和等待。</span>
            </p>
            
            <!-- 【关键修改】添加报告生成按钮 -->
            <button onclick="generateReport()" class="glow-btn mt-6">
                生成观察报告
            </button>

            <button onclick="clearAllAndReload()" class="text-[8px] text-slate-700 hover:text-slate-500 uppercase tracking-widest mt-4">
                重置会话
            </button>
        </div>
    </section>

    <!-- 5. 【V3.2保留】报告视图 -->
    <section id="view-report" class="view px-4">
        <div class="terminal-panel space-y-6 max-w-2xl text-left overflow-y-auto" style="max-height: 80vh;">
            <div class="titration-anchor"><div class="titration-fluid"></div></div>
            
            <h2 class="text-xl md:text-2xl text-cyan-400 italic font-light text-center">观察报告</h2>
            
            <div id="report-content" class="text-sm text-slate-300 leading-relaxed space-y-4 whitespace-pre-wrap font-light" style="font-family: 'Noto Serif SC'">
                正在生成报告...
            </div>
            
            <div class="text-center space-y-4 pt-6 border-t border-white/5">
                <div class="text-[9px] text-slate-600 tracking-widest uppercase">
                    Report ID: <span id="report-id" class="text-cyan-500/50 font-mono">---</span>
                </div>
                <button onclick="switchView('view-landing')" class="glow-btn">返回首页</button>
            </div>
        </div>
    </section>

    <script>
        // ============================================
        // V3.3 融合版核心逻辑
        // 基于 V3.2 完整功能 + 总监版优化
        // ============================================

        // 1. API 配置 - 使用总监版的正确路径
        const getApiBase = () => {
            let origin = 'https://api.geili.space';
            if (typeof window !== 'undefined' && window.__RUNTIME_CONFIG__?.API_ORIGIN) {
                origin = window.__RUNTIME_CONFIG__.API_ORIGIN;
            }
            return origin.replace(/\/$/, '') + '/api/session';
        };
        const API_BASE = getApiBase();

        // 2. 状态管理
        const state = {
            userId: null,
            nickname: '旅人',  // 【总监版新增】
            currentModeIndex: 0,
            modes: [
                { text: "内在关系复盘", label: "INNER_CONFLICT_RESONANCE", value: "INNER_CONFLICT" },
                { text: "亲密关系冲突", label: "INTIMACY_RESONANCE", value: "INTIMACY" },
                { text: "原生家庭冲突", label: "FAMILY_RESONANCE", value: "FAMILY" },
                { text: "职场关系复盘", label: "WORKPLACE_RESONANCE", value: "WORK" }
            ],
            targetGuna: { r: 0.3, t: 0.3, s: 0.4 },
            currentGuna: { r: 0.3, t: 0.3, s: 0.4 },
            isProcessing: false,
            isTyping: false  // 【总监版新增】
        };

        // 3. 初始化 UserId
        function initUser() {
            let uid = localStorage.getItem('inbetween_userId');
            if (!uid) {
                uid = `user-${Date.now().toString(36)}-${Math.random().toString(36).substr(2,5)}`;
                localStorage.setItem('inbetween_userId', uid);
            }
            state.userId = uid;
            document.getElementById('user-id-display').textContent = uid.substr(-6).toUpperCase();
        }
        initUser();

        // 4. 视图切换
        function switchView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            if (viewId === 'view-chat') {
                document.getElementById('user-input').disabled = false;
                document.getElementById('send-btn').disabled = false;
                document.getElementById('user-input').focus();
            }
        }

        // 5. 模式切换
        function cycleMode() {
            state.currentModeIndex = (state.currentModeIndex + 1) % state.modes.length;
            document.getElementById('mode-text').textContent = state.modes[state.currentModeIndex].text;
        }

        // 6. 开始会话
        async function startSession() {
            // 【总监版新增】读取昵称
            const nicknameInput = document.getElementById('nickname-input');
            state.nickname = nicknameInput.value.trim() || '旅人';

            const btn = document.getElementById('start-btn');
            btn.textContent = "CONNECTING...";
            btn.disabled = true;

            const mode = state.modes[state.currentModeIndex].value;

            try {
                // 【修改】使用统一的 API 路径
                const res = await fetch(`${API_BASE}/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: state.userId, mode })
                });

                // 【V3.2保留】代谢锁检测
                if (res.status === 423) {
                    const data = await res.json();
                    showMetabolicLock(data.lockStatus);
                    btn.textContent = "START";
                    btn.disabled = false;
                    return;
                }

                if (!res.ok) throw new Error('Network error');

                const data = await res.json();
                
                if (data.meta) updateResonance(data.meta);
                
                // 【总监版修改】温柔的欢迎语
                const welcomeMsg = `嗨，${state.nickname}。我是 In。<br>这里没有评判，也不需要你这就变好。<br>我只是在这里陪你，把那些缠绕你的念头，稍微理一理。<br><br>告诉我，此刻你的心里，什么东西最沉重？`;
                
                switchView('view-chat');
                
                setTimeout(() => {
                    typeMessage('AI', welcomeMsg);
                }, 800);

            } catch (error) {
                console.error(error);
                alert("无法连接到意识场。请检查后端服务是否启动。");
                btn.textContent = "START";
                btn.disabled = false;
            }
        }

        // 7. 发送消息
        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text || state.isProcessing || state.isTyping) return;

            state.isProcessing = true;
            appendMessage('USER', text);
            input.value = '';
            document.getElementById('typing-indicator').classList.remove('hidden');
            document.getElementById('chat-phase-indicator').textContent = 'PHASE: TITRATING...';

            try {
                // 【修改】使用统一的 API 路径
                const res = await fetch(`${API_BASE}/message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: state.userId, message: text })
                });

                const data = await res.json();

                // 【V3.2保留】代谢锁检测
                if (data.status === 'METABOLIC_LOCK' || (data.status === 'SUCCESS' && data.meta?.shouldLock)) {
                    showMetabolicLock({
                        remainingHours: data.meta?.lockDuration || 48,
                        unlocksAt: Date.now() + (data.meta?.lockDuration || 48) * 3600 * 1000
                    });
                    return;
                }

                // 【总监版修改】使用支持 HTML 的打字效果
                await typeMessage('AI', data.aiResponse);
                if (data.meta) updateResonance(data.meta);

            } catch (error) {
                console.error(error);
                appendMessage('AI', '[场域干扰] 信号同步中断。');
            } finally {
                state.isProcessing = false;
                document.getElementById('typing-indicator').classList.add('hidden');
            }
        }

        // 8. 【总监版修改】支持 HTML 的打字效果
        async function typeMessage(role, fullHtml) {
            state.isTyping = true;
            const flow = document.getElementById('chat-flow');
            const msgContainer = document.createElement('div');
            msgContainer.className = `flex gap-6 animate-fadeIn opacity-100`;
            
            // 【总监版新增】AI 头像
            const avatarHtml = role === 'AI' ? `<div class="ai-avatar shrink-0 mt-1 active"></div>` : '';
            const contentId = `content-${Date.now()}`;
            
            msgContainer.innerHTML = `${avatarHtml}<div id="${contentId}" class="text-sm text-slate-300 leading-relaxed max-w-[85%] font-light italic typing-cursor" style="font-family: 'Noto Serif SC'"></div>`;
            flow.appendChild(msgContainer);
            
            const contentEl = document.getElementById(contentId);
            const avatarEl = msgContainer.querySelector('.ai-avatar');

            // 分割 HTML，提取 <br> 标签
            const parts = fullHtml.split(/(<br\s*\/?>)/i);
            const characters = [];
            parts.forEach(p => {
                if (p.toLowerCase().startsWith('<br')) characters.push('<br>');
                else characters.push(...p.split(''));
            });

            // 逐字打印
            for (let char of characters) {
                if (char === '<br>') contentEl.innerHTML += '<br>';
                else contentEl.innerHTML += char;
                
                flow.scrollTop = flow.scrollHeight;
                
                let delay = 20 + Math.random() * 25;
                if ([',', '，', '.', '。', '?', '？', '!', '！'].includes(char)) {
                    delay += 450;
                }
                
                await new Promise(resolve => setTimeout(resolve, delay));
            }
            
            // 打字结束
            contentEl.classList.remove('typing-cursor');
            if (avatarEl) avatarEl.classList.remove('active');
            state.isTyping = false;
        }

        // 9. 添加消息（用户消息）
        function appendMessage(role, content) {
            const flow = document.getElementById('chat-flow');
            const msgContainer = document.createElement('div');
            
            if (role === 'USER') {
                msgContainer.className = 'flex justify-end';
                msgContainer.innerHTML = `
                    <div class="bg-cyan-500/5 border border-cyan-500/20 rounded-2xl px-4 py-2 max-w-[75%]">
                        <div class="text-sm text-slate-200 font-light">${content}</div>
                    </div>
                `;
            } else {
                msgContainer.className = 'flex gap-6';
                msgContainer.innerHTML = `
                    <div class="ai-avatar shrink-0 mt-1"></div>
                    <div class="text-sm text-slate-300 leading-relaxed max-w-[85%] font-light italic" style="font-family: 'Noto Serif SC'">${content}</div>
                `;
            }
            
            flow.appendChild(msgContainer);
            flow.scrollTop = flow.scrollHeight;
        }

        // 10. 【V3.2保留】生成报告
        async function generateReport() {
            const btn = event?.target;
            if (btn) btn.textContent = "GENERATING...";
            
            try {
                // 【修改】使用统一的 API 路径
                const res = await fetch(`${API_BASE}/report`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: state.userId })
                });
                
                if (!res.ok) throw new Error('Report generation failed');
                const data = await res.json();
                
                document.getElementById('report-content').textContent = data.report.reportText || JSON.stringify(data.report, null, 2);
                document.getElementById('report-id').textContent = data.report.reportId;
                switchView('view-report');
                
            } catch (error) {
                console.error(error);
                alert("报告生成失败，场域数据不足。");
            } finally {
                if (btn) btn.textContent = "生成观察报告";
            }
        }

        // 11. 【V3.2保留】更新 Guna 仪表盘和波形
        function updateResonance(meta) {
            if (meta.guna) {
                state.targetGuna = meta.guna; 
                
                document.getElementById('rajas-bar').style.width = `${meta.guna.rajas * 100}%`;
                document.getElementById('rajas-val').textContent = `${Math.round(meta.guna.rajas * 100)}%`;
                
                document.getElementById('sattva-bar').style.width = `${meta.guna.sattva * 100}%`;
                document.getElementById('sattva-val').textContent = `${Math.round(meta.guna.sattva * 100)}%`;
            }
            
            if (meta.phase) {
                const phaseMap = {
                    'SCANNING': 'SCANNING', 'STORY_SAMPLING': 'SAMPLING',
                    'IDENTIFYING': 'IDENTIFYING', 'PATTERN_EMERGENCE': 'EMERGENCE',
                    'DISSOLUTION_ACTIVE': 'DISSOLVING', 'INTEGRATING': 'INTEGRATING'
                };
                
                const indicator = document.getElementById('chat-phase-indicator');
                indicator.textContent = `PHASE: ${phaseMap[meta.phase] || meta.phase}`;
                
                indicator.style.transform = 'scale(1.1)';
                indicator.style.color = 'var(--sattva-cyan)';
                setTimeout(() => {
                    indicator.style.transform = 'scale(1)';
                    indicator.style.color = '';
                }, 500);
            }
            
            const sattva = state.targetGuna.s || 0.4;
            document.getElementById('subtle-progress').style.width = `${sattva * 100}%`;
            
            // 【V3.2保留】报告按钮显隐
            const reportBtn = document.getElementById('report-trigger');
            if (meta.reportReady) {
                reportBtn.style.opacity = '1';
                reportBtn.style.pointerEvents = 'auto';
            }
        }

        // 12. 【V3.2保留】代谢锁逻辑
        function showMetabolicLock(lockStatus) {
            setTimeout(() => {
                switchView('view-metabolism');
                startMetabolicCountdown(new Date(lockStatus.unlocksAt || Date.now() + 48*3600*1000));
            }, 2500);
        }

        function startMetabolicCountdown(unlockTime) {
            const timerEl = document.getElementById('metabolic-timer');
            const updateTimer = () => {
                const now = new Date();
                const remaining = unlockTime - now;
                if (remaining <= 0) {
                    timerEl.textContent = 'UNLOCKED';
                    return;
                }
                const h = Math.floor(remaining / 3600000);
                const m = Math.floor((remaining % 3600000) / 60000);
                timerEl.textContent = `${h}h ${m}m`;
            };
            updateTimer();
            setInterval(updateTimer, 60000);
        }

        // 13. 退出协议
        function exitProtocol() {
            if (confirm('确定退出当前会话？未保存的对话将丢失。')) {
                switchView('view-landing');
                document.getElementById('chat-flow').innerHTML = '';
                document.getElementById('user-input').value = '';
            }
        }

        // 14. 【V3.2保留】清除并重载
        function clearAllAndReload() {
            if (confirm('确定重置所有会话数据？此操作不可撤销。')) {
                localStorage.removeItem('inbetween_userId');
                location.reload();
            }
        }

        // 15. 【V3.2保留】Canvas 动态波形渲染
        const canvas = document.getElementById('resonance-canvas');
        const ctx = canvas.getContext('2d');
        let time = 0;

        function resizeCanvas() { 
            canvas.width = window.innerWidth; 
            canvas.height = window.innerHeight; 
        }
        window.addEventListener('resize', resizeCanvas); 
        resizeCanvas();

        function lerp(start, end, factor) {
            return start + (end - start) * factor;
        }

        function drawResonance() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            time += 0.005;

            // 平滑插值
            state.currentGuna.r = lerp(state.currentGuna.r, state.targetGuna.rajas || 0.3, 0.05);
            state.currentGuna.s = lerp(state.currentGuna.s, state.targetGuna.sattva || 0.4, 0.05);

            const drawWave = (amplitude, frequency, speed, color, opacity, yOffset) => {
                ctx.beginPath(); 
                ctx.strokeStyle = color; 
                ctx.globalAlpha = opacity; 
                ctx.lineWidth = 1.2;
                
                for (let x = 0; x < canvas.width; x += 3) {
                    const y = yOffset + 
                        Math.sin(x * frequency + time * speed) * amplitude + 
                        Math.sin(x * frequency * 0.5 + time * speed * 0.5) * (amplitude * 0.5);
                    if (x === 0) ctx.moveTo(x, y); 
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            };

            const cy = canvas.height / 2;
            
            // Rajas 波形（动态驱动）
            const rajasAmp = 10 + state.currentGuna.r * 60;
            drawWave(rajasAmp, 0.004, 2, '#f59e0b', 0.15, cy - 10);
            drawWave(rajasAmp * 0.8, 0.005, 2.5, '#f59e0b', 0.1, cy - 10);

            // Sattva 波形（动态驱动）
            const sattvaAmp = 40 - state.currentGuna.s * 20; 
            drawWave(sattvaAmp, 0.002, 1, '#22d3ee', 0.2 + state.currentGuna.s * 0.1, cy + 10);
            drawWave(sattvaAmp * 0.8, 0.0025, 1.2, '#22d3ee', 0.15, cy + 10);

            requestAnimationFrame(drawResonance);
        }
        drawResonance();

        // 16. 输入框回车发送
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('user-input');
            input?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });
    </script>
</body>
</html>
